# FreeRTOS 学习日记 - 第二周第2天

## 🎯 今日任务
改造传感器任务，让DHT11和MPU6050数据通过队列发送，实现数据融合任务，验证整个数据生产-消费流程。

## 🔧 做了什么 & 作用
**主要内容：**
- **改造DHT11任务**：将数据打包并发送到消息队列
  作用：解耦数据采集和数据处理，避免直接打印造成的串口竞争

- **改造MPU6050任务**：将IMU数据发送到专用队列
  作用：让MPU6050数据也进入统一的数据流管理

- **实现数据融合任务**：从两个队列接收数据，合并成完整数据包
  作用：验证整个数据链路是否畅通，为后续的数据处理打下基础

## 🛠️ 实现方法
1. **步骤1：改造DHT11任务**
   - 创建`sensor_data_t`类型的数据包
   - 将温度、湿度、状态码填入对应字段
   - 使用`osMessageQueuePut`发送到`DHT11DataQueueHandle`
   - 移除原有的直接`printf`语句

2. **步骤2：改造MPU6050任务**
   - 同样创建`sensor_data_t`数据包
   - 填充加速度、陀螺仪、IMU温度数据
   - 发送到`MPU6050DataQueueHandle`

3. **步骤3：实现数据融合任务**
   - 定义两个`osMessageQueueGet`分别接收两个队列的数据
   - 设置合理的超时时间（100ms和50ms）
   - 将接收到的数据合并到`fused_packet`
   - 添加时间戳和包序号
   - 每2秒打印一次融合数据包信息

**关键技术点：**
- 使用FreeRTOS的消息队列实现任务间通信
- 数据包采用统一的结构体格式`sensor_data_t`
- 超时机制避免任务因等待数据而阻塞

## ⚠️ 遇到的问题
### 问题1：串口输出乱码后停止
- **现象：** 系统运行一段时间后，串口输出出现乱码字符（如`[?:e6]��···`），然后完全停止，LED也不闪烁
- **原因：** 怀疑是I2C总线竞争或互斥锁死锁导致系统崩溃。MPU6050和OLED共用同一个I2C总线（hi2c1），可能存在时序竞争
- **解决：** 暂时没有完全解决，需要进一步调试（计划明天解决）

### 问题2：DHT11读取失败
- **现象：** DHT11初始化成功但读取返回错误码1
- **原因：** 可能是时序问题或传感器未稳定
- **解决：** 在任务启动后增加了3秒延迟，但问题仍然存在

### 问题3：MPU6050温度数据异常
- **现象：** MPU6050偶尔输出异常温度值（如-27.7°C）
- **原因：** 可能是I2C通信干扰或数据解析错误
- **解决：** 需要检查MPU6050库的数据处理逻辑

## ✅ 最终成果
- **队列系统建立成功：** DHT11和MPU6050都能将数据发送到各自队列
- **数据融合任务工作：** 能够从两个队列接收数据并生成融合数据包
- **数据格式统一：** 所有传感器数据都使用统一的`sensor_data_t`格式

**运行现象：**
- LED：启动时闪烁正常，但系统崩溃后停止闪烁
- OLED：由于系统崩溃，没有观察到后续显示
- 数据：初期能看到MPU6050正常发送数据到队列，融合任务能生成数据包

## 📚 收获与感受
### 技术收获：
1. **掌握了FreeRTOS消息队列的使用：** 学会了如何使用`osMessageQueuePut`和`osMessageQueueGet`进行任务间通信
2. **理解了数据流架构的重要性：** 通过生产-消费模式解耦数据采集和处理
3. **实践了数据融合的基本概念：** 将多个传感器数据合并成统一的数据包

### 经验教训：
1. **时序竞争是嵌入式多任务系统的常见问题：** 特别是共享资源（如I2C总线）需要谨慎处理
2. **调试信息要有序输出：** 避免多个任务同时打印造成的混乱
3. **系统监控很重要：** 需要添加更多系统状态监控，便于问题定位

### 个人感受：
今天的任务从架构设计到具体实现，让我深刻体会到了嵌入式系统开发的复杂性。虽然遇到了系统崩溃的问题，但这正是学习过程中最有价值的部分。通过实际遇到的问题，我更加理解了任务调度、资源共享、错误处理的重要性。明天需要重点解决时序竞争问题，让系统稳定运行起来。

**今日完成度：** 80%（功能实现但稳定性待优化）