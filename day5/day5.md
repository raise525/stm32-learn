# FreeRTOS 学习日记 

## 🎯 今日任务
将DHT11温湿度传感器整合到FreeRTOS多任务系统中，实现传感器数据采集、任务间通信和OLED实时显示。

## 🔧 做了什么 & 作用
**主要内容：**
- 创建Sensor_Task传感器采集任务
  - 作用：周期性读取DHT11温湿度数据，避免阻塞其他任务

- 建立sensorQueue消息队列
  - 作用：实现Sensor_Task和Display_Task之间的数据传递，解耦采集与显示

- 修改Display_Task显示任务
  - 作用：从队列获取温湿度数据并在OLED上实时更新显示

## 🛠️ 实现方法
1. **步骤1：** 在CubeMX中配置FreeRTOS队列，Item Size设为8（匹配DHT11_Data_t结构体大小）
2. **步骤2：** 编写Sensor_Task函数，每2秒读取一次DHT11，成功后发送数据到队列
3. **步骤3：** 修改Display_Task，每1秒从队列尝试获取数据并更新OLED显示
4. **步骤4：** 调整LED_Task作为系统心跳指示，避免任务间LED控制冲突

**关键技术点：**
- 使用osMessageQueue实现任务间异步通信
- DHT11单总线协议的精确时序控制
- OLED显示缓冲区的管理（先清除后写入）

## ⚠️ 遇到的问题
### 问题1：湿度显示字符重叠（显示"H--H:90%"）
- **现象：** OLED显示湿度时新旧字符叠加
- **原因：** 显示缓冲区未清除旧内容，直接写入新数据
- **解决：** 修改显示逻辑，先清除数字区域再写入新值

### 问题2：上电后需要按复位键才能显示
- **现象：** 直接上电OLED无显示，按复位键后正常
- **原因：** OLED初始化时机过早，系统电源和I2C总线未稳定
- **解决：** 在Display_Task开始时增加800ms延时等待系统稳定

### 问题3：Run计数器异常跳变
- **现象：** Run计数器从000001突然跳到大数值
- **原因：** 队列Item Size配置为12，但实际结构体只有8字节，导致内存越界污染了display_counter变量
- **解决：** 将队列Item Size修正为8（sizeof(DHT11_Data_t)）

### 问题4： 有时候没有数据
- 因为产生和消费不同步，但是懒得改了，就这样吧

## ✅ 最终成果
- 成功实现DHT11温湿度传感器在FreeRTOS系统中的稳定运行
- 建立完整的"采集-传递-显示"任务链，4个任务并发执行
- **运行现象：**
  - LED：系统启动时闪3次（DHT11初始化成功），然后每3秒闪一次（系统心跳）
  - OLED：稳定显示"FreeRTOS Day4"、"DHT11 Online"、运行计数器和实时温湿度
  - 数据：温湿度每2秒更新一次，显示正常无残留
  - <video controls src="day5.mp4" title="温湿度显示" width="600"></video>
  

## 📚 收获与感受
### 技术收获：
1. **FreeRTOS队列使用**：理解了osMessageQueue的创建、发送和接收机制
2. **任务间通信**：掌握了生产者-消费者模式在嵌入式系统的实现
3. **内存对齐重要性**：认识到结构体大小、队列配置必须精确匹配
4. **显示缓冲区管理**：学会了"先清除后写入"的显示更新模式

### 经验教训：
1. **嵌入式开发要精确**：队列大小、延时时间等参数不能"差不多"
2. **硬件需要初始化时间**：外设上电后必须等待足够时间才能稳定工作
3. **调试要分步骤**：先确保基本功能正常，再逐步增加复杂度

### 个人感受：
>今天最大的感受是"细节决定成败"。一个看似简单的队列大小配置错误，就能导致整个系统行为异常。嵌入式开发就像精密仪器组装，每一个参数、每一个时序都必须精确无误。当看到温湿度在OLED上稳定更新，四个任务和谐运行时，那种成就感是巨大的。FreeRTOS的多任务机制让复杂系统变得清晰可控，这是裸机编程无法比拟的。

> 好像这个下载器还有串口的功能，可以试试怎么用啊，debug必须要会



## 备注
> 今天没做出来，好像有两种可能：<br>
> 1. 那个结构体没写/* 在freertos.c或单独头文件中 */
typedef struct {
    float temperature;
    float humidity;
    uint32_t timestamp;  // 可记录读取时间
} SensorData_t;
> 2. 难点1：DHT11时序要求,DHT11需要精确的微秒级延时<br>
>FreeRTOS的osDelay是毫秒级<br>
>解决：在DHT11驱动中使用HAL_Delay_us()或硬件定时器
>明天再看吧，现在真的是一点都不想做了

以后的总结模板！
# FreeRTOS 学习日记 

## 🎯 今日任务
[简要描述今天做了什么]

## 🔧 做了什么 & 作用
**主要内容：**
- [任务1描述]
  - 作用：[为什么做这个]

- [任务2描述]
  - 作用：[为什么做这个]

## 🛠️ 实现方法
1. **步骤1：**[具体操作]
2. **步骤2：**[具体操作]
3. **步骤3：**[具体操作]

**关键技术点：**
- [技术点1]
- [技术点2]

## ⚠️ 遇到的问题
### 问题1：[问题描述]
- **现象：** [具体现象]
- **原因：** [分析原因]
- **解决：** [解决方法]

### 问题2：[问题描述]
- **现象：** [具体现象]
- **原因：** [分析原因]
- **解决：** [解决方法]

## ✅ 最终成果
- [成果1]
- [成果2]
- **运行现象：**
  - LED：[LED行为描述]
  - OLED：[显示内容描述]
  - 数据：[数据更新情况]

## 📚 收获与感受
### 技术收获：
1. [收获1]
2. [收获2]
3. [收获3]

### 经验教训：
1. [教训1]
2. [教训2]

### 个人感受：
[学习过程中的感想]