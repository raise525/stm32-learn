# FreeRTOS 学习日记

## 🎯 今日任务
重构数据流，让DHT11传感器数据通过队列同时输出到OLED和串口

## 🔧 做了什么 & 作用
**主要内容：**
- **硬件连接与测试**：连接USB转TTL模块与STM32进行串口通信测试
  作用：建立STM32与电脑的物理通信链路，为数据输出建立通道

- **串口通信验证**：使用VOFA+串口助手验证printf输出功能
  作用：确保串口配置正确，printf重定向工作正常

- **重构DHT11数据流**：修改Sensor_Task任务，将读取的温湿度数据同时输出到串口
  作用：实现"传感器→队列→OLED显示+串口输出"的完整数据流

- **解决数据格式问题**：修正湿度数据显示异常问题
  作用：确保串口输出的数据准确可靠

## 🛠️ 实现方法
1. **步骤1**：硬件连接（USB-TTL_TX→PA10，RX→PA9，GND→GND，ST-Link供电）
2. **步骤2**：编译并烧录包含printf测试代码的程序，验证串口基础通信
3. **步骤3**：在Sensor_Task任务中的DHT11读取成功位置添加printf输出语句
4. **步骤4**：修正数据格式错误（湿度从float格式改为整数格式）

**关键技术点：**
- **printf重定向原理**：通过实现_write函数将标准输出重定向到串口
- **FreeRTOS队列机制**：使用osMessageQueue实现任务间数据传递
- **数据类型匹配**：结构体中humidity为uint8_t，printf需使用%d格式

## ⚠️ 遇到的问题
### 问题1：串口无输出或显示乱码
- **现象：** VOFA+初始连接时显示十六进制数据或部分乱码
- **原因：** VOFA+协议设置错误（使用了FireWater协议而非RawData），编码格式不匹配
- **解决：** 将VOFA+协议改为RawData，调整编码格式，最终采用纯英文输出避免编码问题

### 问题2：湿度数据显示异常
- **现象：** 串口输出的湿度始终显示为"-0.0%"
- **原因：** 数据结构中humidity为uint8_t类型，但printf使用了%.1f浮点数格式
- **解决：** 修改printf格式从%.1f%%改为%d%%，正确显示整数百分比

### 问题3：DHT11偶尔读取失败
- **现象：** 约20%的读取返回error:1
- **原因：** DHT11时序要求严格，可能受任务调度或硬件稳定性影响
- **解决：** 暂时接受一定失败率（不影响功能），后续可增加重试机制

## ✅ 最终成果
- **串口通信稳定建立**：STM32成功通过USART1与电脑通信
- **数据流重构完成**：DHT11数据同时输出到OLED和串口
- **真实数据显示正常**：温度20.x°C，湿度67%等真实环境数据

**运行现象：**
- **LED**：系统启动时闪烁3次表示初始化成功，之后每3秒闪烁一次作为系统心跳
- **OLED**：稳定显示"FreeRTOS Day4"、"DHT11 Online"、运行计数器和实时温湿度数据
- **数据**：串口每2秒输出一次格式化的温湿度数据，包含时间戳和统计信息
```text
[DHT11] Initialization successful
[  2980] #   1 | Temp:  20.7C | Humi:  67% | OK:  1 | Fail:  0
[  5018] #   2 | DHT11 read failed (error: 1) | OK:  1 | Fail:  1
[  7055] #   3 | DHT11 read failed (error: 1) | OK:  1 | Fail:  2
[ 11130] #   5 | Temp:  20.3C | Humi:  67% | OK:  2 | Fail:  3
```

## 📚 收获与感受
### 技术收获：
1. **深入理解printf重定向机制**：明白了标准C库在嵌入式系统中的工作方式
2. **掌握串口调试技巧**：学会了使用VOFA+等串口工具进行数据监测
3. **强化FreeRTOS任务设计**：实践了多任务环境下数据流的合理设计

### 经验教训：
1. **数据类型必须严格匹配**：printf格式化字符串必须与变量类型完全对应
2. **硬件调试要有耐心**：串口通信需要仔细检查接线（TX-RX交叉）、波特率等细节
3. **编码问题早避免**：嵌入式系统中优先使用英文输出，避免编码兼容性问题

### 个人感受：
今天是从"软件配置"到"硬件实际运行"的关键一天。当在VOFA+中第一次看到真实的温湿度数据时，那种成就感非常强烈！虽然遇到了数据格式和编码等小问题，但通过逐步排查都得到了解决。最让我印象深刻的是：**嵌入式开发中，一个小的数据类型不匹配就能导致完全错误的结果**（如湿度显示-0.0%）。这提醒我在编程时要更加细心。现在系统已经稳定运行，数据流架构验证成功，为后续集成MPU6050和ESP32打下了坚实基础。期待明天的优化和传感器扩展工作！